#!/bin/bash

# This script is a wrapper to the python script
# of the same name.
# It should be sourced, not executed.
# It reads the options/args description from stdin
# and outputs a script which parses the command
# line and performs some automatic checks.

# This wraps the local version of the script
# rather than the installed one, for debugging
# purposes.
# It also allows to optionally inspect the
# generated script.

if [[ -n "${FUNCNAME[0]}" ]]
then
	BASH_OPTPARSE_IS_IN_FUNC="true"
	exit_cmd="return"
else
	BASH_OPTPARSE_IS_IN_FUNC="false"
	exit_cmd="exit"
fi
export BASH_OPTPARSE_IS_IN_FUNC

export PYTHONPATH="../src:../build/src:$PYTHONPATH"

py_script_name="../src/bash_optparse.py"

[[ -f "$py_script_name" ]] || { echo "$(basename $0): error: python script $py_script_name not found" >> /dev/stderr; unset BASH_OPTPARSE_IS_IN_FUNC; $exit_cmd 1; }

for req_command in getopt egrep gawk
do
	which "$req_command" &> /dev/null || { echo "$(basename $0): error: $req_command command not found" >> /dev/stderr; unset BASH_OPTPARSE_IS_IN_FUNC; $exit_cmd 1; }
done


AUX_FUNCS="$(python3 -B $py_script_name)"
[[ $? -eq 0 ]] || { unset BASH_OPTPARSE_IS_IN_FUNC; $exit_cmd 1; }

if [[ "$BOP_LOCAL_INSPECT" == "true" ]]
then
	echo "$AUX_FUNCS"
	unset BASH_OPTPARSE_IS_IN_FUNC
	$exit_cmd 0
fi

. <(echo "$AUX_FUNCS" && unset AUX_FUNCS)
BASH_OPTPARSE_RETURN_VAL=$?

unset BASH_OPTPARSE_IS_IN_FUNC

[[ -n "${FUNCNAME[0]}" ]] && return $BASH_OPTPARSE_RETURN_VAL
